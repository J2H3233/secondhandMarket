<% 
    // 레이아웃 변수 설정
    title = '채팅방 - 한성마켓';
    additionalCSS = ['/css/chatRoom.css'];
%>
<div class="chat-container">
    <!-- 채팅 영역 -->
    <div class="chat-area">
        <div class="chat-header">
            <h2 id="current-room-name">채팅방을 선택하세요</h2>
        </div>
        
        <div class="messages-container" id="messages-container">
            <div class="no-room-selected" id="no-room-message">
                채팅방을 선택하여 대화를 시작하세요
            </div>
        </div>
        
        <div class="input-area" id="input-area" style="display: none;">
            <div class="input-container">
                <input type="text" class="message-input" id="message-input" placeholder="메시지를 입력하세요..." maxlength="1000">
                <button class="send-btn" id="send-btn">전송</button>
            </div>
        </div>
    </div>

    <!-- 채팅방 목록 -->
    <div class="room-list">
        <div class="room-list-header">
            <h3>채팅방 목록</h3>
        </div>
        
        <div class="room-item" data-room-id="1">
            <div class="room-name">일반 채팅방</div>
            <div class="room-last-message">안녕하세요!</div>
        </div>
        
        <div class="room-item" data-room-id="2">
            <div class="room-name">개발팀 채팅방</div>
            <div class="room-last-message">프로젝트 진행상황 공유</div>
        </div>
        
        <div class="room-item" data-room-id="3">
            <div class="room-name">자유 주제</div>
            <div class="room-last-message">오늘 점심 뭐 먹을까요?</div>
        </div>
    </div>
</div>

<script>
    let currentRoomId = null;
    let messages = {
        1: [
            { type: 'received', text: '안녕하세요! 일반 채팅방에 오신 것을 환영합니다.', time: '14:30' },
            { type: 'sent', text: '안녕하세요!', time: '14:31' }
        ],
        2: [
            { type: 'received', text: '프로젝트 진행상황을 공유해주세요.', time: '13:20' },
            { type: 'sent', text: '현재 80% 정도 완료되었습니다.', time: '13:25' }
        ],
        3: [
            { type: 'received', text: '오늘 점심 뭐 먹을까요?', time: '12:00' },
            { type: 'sent', text: '한식 어떠세요?', time: '12:05' }
        ]
    };

    // DOM 요소들
    const roomItems = document.querySelectorAll('.room-item');
    const messagesContainer = document.getElementById('messages-container');
    const currentRoomName = document.getElementById('current-room-name');
    const inputArea = document.getElementById('input-area');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const noRoomMessage = document.getElementById('no-room-message');

    // 채팅방 선택 이벤트
    roomItems.forEach(item => {
        item.addEventListener('click', () => {
            const roomId = item.dataset.roomId;
            selectRoom(roomId, item);
        });
    });

    // 메시지 전송 이벤트
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function selectRoom(roomId, roomElement) {
        // 이전 선택된 방 비활성화
        roomItems.forEach(item => item.classList.remove('active'));
        
        // 현재 방 활성화
        roomElement.classList.add('active');
        currentRoomId = roomId;
        
        // 헤더 업데이트
        const roomName = roomElement.querySelector('.room-name').textContent;
        currentRoomName.textContent = roomName;
        
        // 입력 영역 표시
        inputArea.style.display = 'block';
        noRoomMessage.style.display = 'none';
        
        // 메시지 로드
        loadMessages(roomId);
    }

    function loadMessages(roomId) {
        messagesContainer.innerHTML = '';
        
        if (messages[roomId]) {
            messages[roomId].forEach(message => {
                addMessageToDOM(message);
            });
        }
        
        scrollToBottom();
    }

    function addMessageToDOM(message) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', message.type);
        messageDiv.textContent = message.text;
        messagesContainer.appendChild(messageDiv);
    }

    function sendMessage() {
        const text = messageInput.value.trim();
        
        if (text && currentRoomId) {
            const message = {
                type: 'sent',
                text: text,
                time: new Date().toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                })
            };
            
            // 메시지 저장
            if (!messages[currentRoomId]) {
                messages[currentRoomId] = [];
            }
            messages[currentRoomId].push(message);
            
            // DOM에 추가
            addMessageToDOM(message);
            
            // 입력창 초기화
            messageInput.value = '';
            
            // 스크롤 하단으로
            scrollToBottom();
            
            // 채팅방 목록의 마지막 메시지 업데이트
            updateLastMessage(currentRoomId, text);
        }
    }

    function updateLastMessage(roomId, text) {
        const roomItem = document.querySelector(`[data-room-id="${roomId}"]`);
        if (roomItem) {
            const lastMessageElement = roomItem.querySelector('.room-last-message');
            lastMessageElement.textContent = text;
        }
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
</script>