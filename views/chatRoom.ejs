<% 
    // ë ˆì´ì•„ì›ƒ ë³€ìˆ˜ ì„¤ì •
    title = 'ì±„íŒ…ë°© - ì¤‘ê³ ë§ˆì¼“';
    additionalCSS = ['/css/chatRoom.css'];
%>

<script src="/socket.io/socket.io.js"></script>

<style>
    /* --- ì¶”ê°€ëœ CSS ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ + ê¸°ëŠ¥ ì¶”ê°€) --- */
    
    /* ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆë¥¼ Flexboxë¡œ ì„¤ì •í•˜ì—¬ ì¢Œìš° ì •ë ¬ ê°€ëŠ¥í•˜ê²Œ í•¨ */
    .messages-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 20px;
        overflow-y: auto;
        background: #f5f7fb; /* ë°°ê²½ìƒ‰ ì‚´ì§ ë³€ê²½ */
    }

    /* ê³µí†µ ë§í’ì„  ìŠ¤íƒ€ì¼ */
    .message {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 15px;
        position: relative;
        font-size: 0.95rem;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ inside message */
    .message img {
        max-width: 100%;
        border-radius: 10px;
        margin-bottom: 5px;
        display: block;
    }

    /* 1. ë‚´ ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½, ë…¸ë€ìƒ‰) */
    .message.sent {
        align-self: flex-end;
        background-color: #FFC107; /* ì¤‘ê³ ë§ˆì¼“ í¬ì¸íŠ¸ ì»¬ëŸ¬ */
        color: #333;
        border-bottom-right-radius: 2px;
    }

    /* 2. ìƒëŒ€ë°© ë©”ì‹œì§€ (ì™¼ìª½, íšŒìƒ‰) */
    .message.received {
        align-self: flex-start;
        background-color: #ffffff;
        border: 1px solid #eee;
        color: #333;
        border-top-left-radius: 2px;
    }

    /* ì‹œìŠ¤í…œ ë©”ì‹œì§€ (ì¤‘ì•™) */
    .message.system {
        align-self: center;
        background: rgba(0,0,0,0.05);
        color: #666;
        font-size: 0.8rem;
        padding: 5px 20px;
        border-radius: 20px;
        box-shadow: none;
    }

    /* ê±°ë˜ ìƒíƒœ ë³€ê²½ ìŠ¹ì¸ ìš”ì²­ (ì¤‘ì•™) */
    .message.status-request {
        align-self: center;
        background: #fff3cd;
        border: 1px solid #ffc107;
        color: #333;
        font-size: 0.9rem;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        max-width: 80%;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .status-request-text {
        font-weight: bold;
        text-align: center;
    }

    .status-request-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .status-request-btn {
        padding: 8px 20px;
        border: none;
        border-radius: 5px;
        font-size: 0.85rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
    }

    .status-request-btn.accept {
        background: #28a745;
        color: white;
    }

    .status-request-btn.accept:hover {
        background: #218838;
    }

    .status-request-btn.reject {
        background: #dc3545;
        color: white;
    }

    .status-request-btn.reject:hover {
        background: #c82333;
    }

    .status-request-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ë°œì‹ ì ì´ë¦„ í‘œì‹œ */
    .message-sender {
        display: block;
        font-size: 0.75rem;
        font-weight: bold;
        margin-bottom: 3px;
        color: #555;
    }

    .message.sent .message-sender {
        text-align: right;
        color: #666;
    }

    .message.received .message-sender {
        text-align: left;
        color: #0066cc;
    }

    /* ì‹œê°„ í‘œì‹œ */
    .message-time {
        display: block;
        font-size: 0.7rem;
        color: #777; /* ê°€ë…ì„±ì„ ìœ„í•´ ìƒ‰ìƒ ì¡°ì • */
        margin-top: 4px;
        text-align: right;
    }

    /* í—¤ë” ì˜ì—­ ìˆ˜ì • */
    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        background: #fff;
    }

    .chat-header-left {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .chat-header-left h2 {
        margin: 0;
        font-size: 1.1rem;
        color: #333;
    }

    .chat-other-user {
        font-size: 0.8rem;
        color: #888;
    }

    /* ê±°ë˜ ìƒíƒœ ì˜ì—­ */
    .trade-status-area {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* ìƒíƒœ ì»¨íŠ¸ë¡¤ ë°” */
    .status-control-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
        gap: 10px;
    }

    .status-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .status-btn {
        padding: 8px 14px;
        border: 2px solid #dee2e6;
        border-radius: 20px;
        background: white;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .status-btn:hover {
        border-color: #667eea;
        background: #f8f9ff;
    }

    .status-btn.active {
        border-color: #667eea;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .status-btn.danger {
        color: #dc3545;
    }

    .status-btn.danger:hover {
        border-color: #dc3545;
        background: #fff5f5;
    }

    .status-btn.danger.active {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border-color: #dc3545;
    }

    .send-status-request-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .send-status-request-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .send-status-request-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ë¬´í•œ ìŠ¤í¬ë¡¤ ë¡œë”© */
    .load-more-trigger {
        text-align: center;
        padding: 15px;
        color: #888;
        font-size: 0.85rem;
    }

    .load-more-spinner {
        animation: spin 1s linear infinite;
        display: inline-block;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* ê±°ë˜ ìƒíƒœ ë“œë¡­ë‹¤ìš´ */
    .trade-status-select {
        padding: 5px 10px;
        border-radius: 20px;
        border: 1px solid #ddd;
        background: #fff;
        font-size: 0.85rem;
        font-weight: bold;
        cursor: pointer;
    }

    /* ìš”ì²­ ë²„íŠ¼ */
    .request-status-btn {
        padding: 6px 16px;
        border: none;
        border-radius: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 0.85rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .request-status-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .request-status-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ì…ë ¥ì°½ ì˜ì—­ ìˆ˜ì • (ì´ë¯¸ì§€ ë²„íŠ¼ ì¶”ê°€) */
    .input-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .file-btn-label {
        font-size: 1.5rem;
        cursor: pointer;
        color: #888;
        transition: color 0.2s;
    }
    .file-btn-label:hover { color: #333; }
    #file-input { display: none; } /* ì‹¤ì œ íŒŒì¼ ì¸í’‹ì€ ìˆ¨ê¹€ */

    /* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° */
    #image-preview {
        display: none;
        padding: 10px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
        position: relative;
    }
    #image-preview img {
        max-height: 100px;
        border-radius: 5px;
        border: 1px solid #ddd;
    }
    #preview-close {
        position: absolute;
        left: 100px; /* ì´ë¯¸ì§€ í¬ê¸°ì— ë”°ë¼ ì¡°ì • */
        top: 5px;
        background: red;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        font-size: 12px;
        line-height: 18px;
        text-align: center;
    }

    /* ìƒíƒœ ë±ƒì§€ */
    .status-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        background: #e9ecef;
        color: #333;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s ease;
    }
    .status-badge.pending { background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); color: #856404; }
    .status-badge.in_person { background: linear-gradient(135deg, #d4edda 0%, #b8dfc2 100%); color: #155724; }
    .status-badge.shipping { background: linear-gradient(135deg, #cce5ff 0%, #a8d4ff 100%); color: #004085; }
    .status-badge.canceled { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; }
    .status-badge.completed { background: linear-gradient(135deg, #d1e7dd 0%, #badbcc 100%); color: #0f5132; }

    /* ìƒíƒœ ë³€ê²½ ìš”ì²­ ë©”ì‹œì§€ ì¹´ë“œ */
    .message.status-change-request {
        align-self: center;
        background: #ffffff;
        border: none;
        padding: 0;
        border-radius: 16px;
        max-width: 320px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        overflow: hidden;
    }

    .status-change-card {
        width: 100%;
    }

    .status-change-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 20px;
        text-align: center;
    }

    .status-change-header-icon {
        font-size: 1.5rem;
        margin-bottom: 8px;
    }

    .status-change-header-title {
        font-size: 0.9rem;
        font-weight: 600;
        opacity: 0.95;
    }

    .status-change-body {
        padding: 20px;
        text-align: center;
    }

    .status-change-from-to {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .status-change-arrow {
        color: #667eea;
        font-size: 1.2rem;
    }

    .status-change-badge {
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-change-badge.old {
        background: #f1f3f5;
        color: #868e96;
        text-decoration: line-through;
    }

    .status-change-badge.new {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .status-change-requester {
        font-size: 0.8rem;
        color: #868e96;
        margin-top: 5px;
    }

    .status-change-buttons {
        display: flex;
        border-top: 1px solid #eee;
    }

    .status-change-btn {
        flex: 1;
        padding: 14px;
        border: none;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .status-change-btn.accept {
        background: #4caf50;
        color: white;
    }

    .status-change-btn.accept:hover {
        background: #43a047;
    }

    .status-change-btn.reject {
        background: #f5f5f5;
        color: #666;
    }

    .status-change-btn.reject:hover {
        background: #eee;
    }

    .status-change-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .status-change-result {
        padding: 14px;
        text-align: center;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .status-change-result.approved {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
    }

    .status-change-result.rejected {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
    }

    .status-change-result.pending {
        background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
        color: #856404;
    }

    /* ê±°ë˜ ìš”ì²­ ë©”ì‹œì§€ (ê°œì„ ëœ UI) */
    .message.trade-request-message {
        align-self: center;
        background: white;
        border: none;
        padding: 0;
        border-radius: 16px;
        max-width: 90%;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .trade-request-card {
        width: 100%;
    }

    .trade-request-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        font-size: 1rem;
        text-align: center;
    }

    .trade-request-details {
        padding: 15px 20px;
        background: #f8f9fa;
    }

    .detail-item {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }

    .detail-item:last-child {
        border-bottom: none;
    }

    .detail-item.highlight {
        background: #fff8e1;
        margin: 10px -20px -15px -20px;
        padding: 15px 20px;
    }

    .detail-icon {
        font-size: 1.2rem;
        margin-right: 10px;
    }

    .detail-label {
        color: #666;
        font-size: 0.85rem;
        min-width: 80px;
    }

    .detail-value {
        flex: 1;
        font-weight: 500;
        text-align: right;
    }

    .detail-value.price {
        color: #e53935;
        font-size: 1.2rem;
        font-weight: bold;
    }

    .trade-request-buttons {
        display: flex;
        border-top: 1px solid #eee;
        gap: 0;
    }

    .trade-request-buttons .trade-request-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        font-size: 0.95rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 0;
        margin: 0;
    }

    .trade-request-buttons .trade-request-btn.accept {
        background: #4caf50;
        color: white;
        border-bottom-left-radius: 12px;
    }

    .trade-request-buttons .trade-request-btn.reject {
        background: #f44336;
        color: white;
        border-bottom-right-radius: 12px;
    }

    .trade-request-buttons .trade-request-btn:hover {
        filter: brightness(1.1);
    }

    .request-result {
        text-align: center;
        padding: 12px;
        font-size: 0.95rem;
    }

    .request-result.approved {
        background: #d4edda;
        color: #155724;
    }

    .request-result.rejected {
        background: #f8d7da;
        color: #721c24;
    }

    .request-pending {
        text-align: center;
        padding: 12px;
        background: #fff3cd;
        color: #856404;
        font-size: 0.9rem;
    }
</style>

<div class="chat-page">
    <div class="chat-island">
        <div class="chat-container">
            
            <div class="room-list">
                <div class="room-list-header">
                    <h3>ì±„íŒ…ë°© ëª©ë¡</h3>
                </div>
                
                <div class="room-items-container">
                    <% if (typeof chatRooms !== 'undefined' && chatRooms && chatRooms.length > 0) { %>
                        <% chatRooms.forEach(function(room) { %>
                            <div class="room-item" data-room-id="<%= room.id %>" data-post-id="<%= room.postId %>" data-post-title="<%= room.postTitle || 'ìƒí’ˆëª… ì—†ìŒ' %>" data-other-user="<%= room.otherUserName %>" data-status="<%= room.status %>">
                                <div class="room-thumbnail">
                                    <% if (room.postImageUrl) { %>
                                        <img src="/uploads/temp/<%= room.postImageUrl %>" alt="ìƒí’ˆ ì´ë¯¸ì§€">
                                    <% } else { %>
                                        <img src="https://via.placeholder.com/50x50/E2E8F0/718096?text=No" alt="ì´ë¯¸ì§€ ì—†ìŒ">
                                    <% } %>
                                </div>
                                <div class="room-info">
                                    <div class="room-name"><%= room.postTitle || 'ìƒí’ˆëª… ì—†ìŒ' %></div>
                                    <div class="room-other-user"><%= room.otherUserName %></div>
                                    <div class="room-last-message"><%= room.lastMessage || 'ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”' %></div>
                                </div>
                                <div class="room-meta">
                                    <span class="room-status <%= room.status.toLowerCase() %>"><%= getStatusBadge(room.status) %></span>
                                    <span class="room-time"><%= formatTimeAgo(room.lastMessageTime || room.updatedAt) %></span>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="no-rooms-message" style="text-align: center; padding: 40px; color: #888;">
                            <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>
                            <p>ì•„ì§ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p style="font-size: 0.9em;">ê´€ì‹¬ìˆëŠ” ìƒí’ˆì—ì„œ íŒë§¤ìì—ê²Œ ì—°ë½í•´ë³´ì„¸ìš”!</p>
                        </div>
                    <% } %>
                </div>
            </div>

            <div class="chat-area">
                
                <div class="chat-header">
                    <div class="chat-header-left">
                        <h2 id="current-room-name">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                        <span id="current-other-user" class="chat-other-user"></span>
                    </div>
                    
                    <div class="trade-status-area" id="trade-status-area" style="display: none;">
                        <span id="current-status-badge" class="status-badge">ğŸ¤ í˜‘ì˜ì¤‘</span>
                    </div>
                </div>
                
                <!-- ìƒíƒœ ë³€ê²½ ë²„íŠ¼ ì˜ì—­ -->
                <div class="status-control-bar" id="status-control-bar" style="display: none;">
                    <div class="status-buttons">
                        <button class="status-btn" data-status="IN_PERSON" data-needs-info="true" title="ì§ê±°ë˜ ìš”ì²­">ğŸš¶ ì§ê±°ë˜</button>
                        <button class="status-btn" data-status="SHIPPING" data-needs-info="true" title="ë°°ì†¡ ìš”ì²­">ğŸšš ë°°ì†¡</button>
                        <button class="status-btn" data-status="COMPLETED" title="ê±°ë˜ì™„ë£Œ ìš”ì²­">âœ… ì™„ë£Œ</button>
                        <button class="status-btn danger" data-status="CANCELED" title="ê±°ë˜ì·¨ì†Œ ìš”ì²­">âŒ ì·¨ì†Œ</button>
                    </div>
                </div>
                
                <div class="messages-container" id="messages-container">
                    <div id="load-more-trigger" class="load-more-trigger" style="display: none;">
                        <span class="load-more-spinner">â³</span> ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                    <div class="no-room-selected" id="no-room-message">
                        <p style="text-align: center; color: #888; margin-top: 200px;">
                            ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì—¬ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”
                        </p>
                    </div>
                </div>
                
                <div class="input-area" id="input-area" style="display: none;">
                    
                    <div id="image-preview">
                        <img src="" id="preview-img" alt="preview">
                        <div id="preview-close" onclick="clearImage()">X</div>
                    </div>

                    <div class="input-container">
                        <label for="file-input" class="file-btn-label">ğŸ“·</label>
                        <input type="file" id="file-input" accept="image/*">

                        <input type="text" class="message-input" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="1000">
                        <button class="send-btn" id="send-btn">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    console.log('=== ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ===');
    const socket = io();
    console.log('ì†Œì¼“ ì—°ê²°ë¨');

    // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë¡œê·¸ì¸ ì •ë³´
    <% if (user) { %>
    const myUserId = <%= user.userId %>;
    const myUserName = "<%= user.userName %>";
    console.log('ë¡œê·¸ì¸ ìœ ì €:', myUserId, myUserName);
    <% } else { %>
    const myUserId = null;
    const myUserName = "ê²ŒìŠ¤íŠ¸";
    console.log('ê²ŒìŠ¤íŠ¸ ìœ ì €');
    <% } %>

    let currentRoomId = null;
    let currentPostId = null;
    let currentPostTitle = null;
    let selectedImageBase64 = null;
    let currentStatus = 'PENDING';
    
    // ë¬´í•œ ìŠ¤í¬ë¡¤ ê´€ë ¨
    let isLoadingMessages = false;
    let hasMoreMessages = true;
    let oldestMessageId = null;

    // DOM ìš”ì†Œ
    const roomItems = document.querySelectorAll('.room-item');
    const messagesContainer = document.getElementById('messages-container');
    const currentRoomName = document.getElementById('current-room-name');
    const currentOtherUser = document.getElementById('current-other-user');
    const inputArea = document.getElementById('input-area');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const noRoomMessage = document.getElementById('no-room-message');
    
    const fileInput = document.getElementById('file-input');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const statusArea = document.getElementById('trade-status-area');
    const statusControlBar = document.getElementById('status-control-bar');
    const statusButtons = document.querySelectorAll('.status-btn');
    const currentStatusBadge = document.getElementById('current-status-badge');
    const loadMoreTrigger = document.getElementById('load-more-trigger');

    // í—¬í¼ í•¨ìˆ˜ë“¤
    function getStatusText(status) {
        const statusMap = {
            'PENDING': 'í˜‘ì˜ì¤‘',
            'IN_PERSON': 'ì§ê±°ë˜',
            'SHIPPING': 'ë°°ì†¡',
            'CANCELED': 'ê±°ë˜ì·¨ì†Œ',
            'COMPLETED': 'ê±°ë˜ì™„ë£Œ'
        };
        return statusMap[status] || status;
    }

    function getStatusEmoji(status) {
        const emojiMap = {
            'PENDING': 'ğŸ¤',
            'IN_PERSON': 'ğŸš¶',
            'SHIPPING': 'ğŸšš',
            'CANCELED': 'âŒ',
            'COMPLETED': 'âœ…'
        };
        return emojiMap[status] || 'ğŸ”„';
    }

    function getStatusBadge(status) {
        return `${getStatusEmoji(status)} ${getStatusText(status)}`;
    }

    function updateStatusBadge(status) {
        if (currentStatusBadge) {
            currentStatusBadge.textContent = getStatusBadge(status);
            currentStatusBadge.className = 'status-badge ' + status.toLowerCase();
        }
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

    // 1. ì±„íŒ…ë°© ì„ íƒ
    console.log('roomItems ê°œìˆ˜:', roomItems.length);
    roomItems.forEach((item, index) => {
        console.log(`roomItem[${index}] ë“±ë¡:`, item.dataset.roomId);
        item.addEventListener('click', () => {
            console.log('ì±„íŒ…ë°© í´ë¦­ë¨:', item.dataset.roomId);
            const roomId = item.dataset.roomId;
            const postId = item.dataset.postId;
            const postTitle = item.dataset.postTitle;
            const otherUser = item.dataset.otherUser;
            const status = item.dataset.status;
            selectRoom(roomId, postId, postTitle, otherUser, status, item);
        });
    });

    // 2. ë©”ì‹œì§€ ì „ì†¡
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // 3. ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                selectedImageBase64 = event.target.result;
                previewImg.src = selectedImageBase64;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // 4. ìƒíƒœ ë²„íŠ¼ í´ë¦­
    statusButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const status = btn.dataset.status;
            const needsInfo = btn.dataset.needsInfo === 'true';
            
            // ì§ê±°ë˜ ë˜ëŠ” íƒë°° ìš”ì²­ì¸ ê²½ìš° ëª¨ë‹¬ ì—´ê¸°
            if (needsInfo) {
                openTradeModal(status);
            } else {
                // ì™„ë£Œ/ì·¨ì†Œ ìš”ì²­ì€ ë°”ë¡œ ìƒíƒœ ë³€ê²½ ìš”ì²­ ì „ì†¡
                sendStatusChangeRequest(status);
            }
        });
    });

    // 5. ë¬´í•œ ìŠ¤í¬ë¡¤ (ìœ„ë¡œ ìŠ¤í¬ë¡¤ ì‹œ ì´ì „ ë©”ì‹œì§€ ë¡œë“œ)
    messagesContainer.addEventListener('scroll', () => {
        if (messagesContainer.scrollTop < 100 && !isLoadingMessages && hasMoreMessages && currentRoomId) {
            loadMoreMessages();
        }
    });


    // --- ì†Œì¼“ ìˆ˜ì‹  (Server -> Client) ---

    // ë©”ì‹œì§€ ë°›ê¸°
    socket.on('receive_message', (data) => {
        if (data.room == currentRoomId) {
            const type = (data.user == myUserId) ? 'sent' : 'received';
            
            addMessageToDOM({
                id: data.messageId,
                type: type,
                text: data.message,
                image: data.image,
                time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                sender: data.userName || data.user
            });
            scrollToBottom();
            
            updateLastMessage(data.room, data.message || "ğŸ“· ì‚¬ì§„");
        }
    });

    // ìƒíƒœ ë³€ê²½ ìš”ì²­ ë°›ê¸° (í†µí•©)
    socket.on('receive_status_request', (data) => {
        console.log('ìƒíƒœ ë³€ê²½ ìš”ì²­ ìˆ˜ì‹ :', data);
        if (data.room == currentRoomId && data.user != myUserId) {
            addStatusRequestToDOM({
                requestId: data.messageId,
                userName: data.userName,
                requestedStatus: data.requestedStatus,
                currentStatus: data.currentStatus,
                regionName: data.regionName,
                addressDetail: data.addressDetail,
                amount: data.amount,
                isMine: false
            });
            scrollToBottom();
        }
    });

    // ìƒíƒœ ë³€ê²½ ì‘ë‹µ ë°›ê¸° (í†µí•©)
    socket.on('status_request_response', (data) => {
        console.log('ìƒíƒœ ë³€ê²½ ì‘ë‹µ ìˆ˜ì‹ :', data);
        if (data.room == currentRoomId) {
            const requestDiv = document.querySelector(`[data-request-id="${data.messageId}"]`);
            
            if (data.approved) {
                currentStatus = data.newStatus;
                updateStatusBadge(data.newStatus);
                updateRoomStatusBadge(data.room, data.newStatus);
                
                if (requestDiv) {
                    const buttonsArea = requestDiv.querySelector('.trade-request-buttons');
                    if (buttonsArea) {
                        buttonsArea.outerHTML = '<div class="request-result approved"><strong>âœ… ìŠ¹ì¸ë¨</strong></div>';
                    }
                }
                
                addMessageToDOM({
                    type: 'system',
                    text: `ê±°ë˜ ìƒíƒœê°€ '${getStatusText(data.newStatus)}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`
                });
            } else {
                if (requestDiv) {
                    const buttonsArea = requestDiv.querySelector('.trade-request-buttons');
                    if (buttonsArea) {
                        buttonsArea.outerHTML = '<div class="request-result rejected"><strong>âŒ ê±°ë¶€ë¨</strong></div>';
                    }
                }
                
                addMessageToDOM({
                    type: 'system',
                    text: 'ìƒíƒœ ë³€ê²½ ìš”ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.'
                });
            }
            scrollToBottom();
        }
    });


    // --- ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ---

    async function selectRoom(roomId, postId, postTitle, otherUser, status, roomElement) {
        console.log('selectRoom í˜¸ì¶œë¨:', { roomId, postId, postTitle, otherUser, status });
        
        if (currentRoomId == roomId) {
            console.log('ê°™ì€ ë°©ì´ë¯€ë¡œ ë¬´ì‹œ');
            return;
        }

        // UI í™œì„±í™” ì²˜ë¦¬
        roomItems.forEach(item => item.classList.remove('active'));
        roomElement.classList.add('active');
        
        // ì±„íŒ…ë°© ì œëª©ì„ ê²Œì‹œê¸€ëª…ìœ¼ë¡œ ì„¤ì •
        currentRoomName.textContent = postTitle || 'ìƒí’ˆëª… ì—†ìŒ';
        currentOtherUser.textContent = otherUser + 'ë‹˜ê³¼ì˜ ëŒ€í™”';
        
        inputArea.style.display = 'block';
        statusArea.style.display = 'flex';
        statusControlBar.style.display = 'flex';
        noRoomMessage.style.display = 'none';
        
        // ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” (ë¡œë”© íŠ¸ë¦¬ê±°ì™€ no-room-messageë§Œ ë‚¨ê¸°ê³  ëª¨ë‘ ì œê±°)
        const childrenToRemove = Array.from(messagesContainer.children).filter(child => {
            return child.id !== 'load-more-trigger' && child.id !== 'no-room-message';
        });
        childrenToRemove.forEach(child => child.remove());
        loadMoreTrigger.style.display = 'none';

        currentRoomId = roomId;
        currentPostId = postId;
        currentPostTitle = postTitle;
        currentStatus = status;
        hasMoreMessages = true;
        oldestMessageId = null;
        
        updateStatusBadge(status);

        // ì†Œì¼“ ë°© ì…ì¥
        console.log('ì†Œì¼“ ë°© ì…ì¥:', roomId);
        socket.emit('join_room', roomId);

        // ê¸°ì¡´ ë©”ì‹œì§€ ë¡œë“œ
        console.log('loadMessages í˜¸ì¶œ ì „');
        await loadMessages(roomId);
        console.log('loadMessages ì™„ë£Œ');
    }

    // ë©”ì‹œì§€ ë¡œë“œ (ì´ˆê¸° ë¡œë“œ ë° ë¬´í•œ ìŠ¤í¬ë¡¤)
    async function loadMessages(roomId, beforeId = null) {
        if (isLoadingMessages) return;
        isLoadingMessages = true;
        
        console.log('ë©”ì‹œì§€ ë¡œë“œ ì‹œì‘:', { roomId, beforeId });
        
        if (beforeId) {
            loadMoreTrigger.style.display = 'block';
        }

        try {
            let url = `/api/chat/${roomId}/messages?limit=30`;
            if (beforeId) {
                url += `&beforeId=${beforeId}`;
            }
            
            console.log('API í˜¸ì¶œ:', url);
            
            const response = await fetch(url);
            const result = await response.json();
            
            console.log('API ì‘ë‹µ:', result);
            console.log('ì‘ë‹µ ìƒì„¸:', { 
                code: result.code, 
                hasResult: !!result.result,
                messages: result.result?.messages,
                messagesCount: result.result?.messages?.length,
                hasMore: result.result?.hasMore
            });
            
            if (result.code === 200 && result.result) {
                const { messages, hasMore } = result.result;
                hasMoreMessages = hasMore;
                
                if (messages.length > 0) {
                    // ê°€ì¥ ì˜¤ë˜ëœ ë©”ì‹œì§€ ID ì €ì¥
                    oldestMessageId = messages[0].id;
                    
                    // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ (ë¬´í•œ ìŠ¤í¬ë¡¤ ì‹œ)
                    const scrollHeightBefore = messagesContainer.scrollHeight;
                    
                    // ë©”ì‹œì§€ë¥¼ DOMì— ì¶”ê°€
                    messages.forEach((msg, index) => {
                        const type = (msg.senderId == myUserId) ? 'sent' : 'received';
                        
                        // ìƒíƒœ ë³€ê²½ ìš”ì²­ ë©”ì‹œì§€ì¸ ê²½ìš° (JSON í˜•ì‹)
                        const statusRequestTypes = ['PENDING', 'IN_PERSON', 'SHIPPING', 'CANCELED', 'COMPLETED'];
                        if (statusRequestTypes.includes(msg.messageType)) {
                            try {
                                const requestData = JSON.parse(msg.content);
                                // STATUS_REQUEST ë˜ëŠ” TRADE_REQUEST íƒ€ì…ì¸ ê²½ìš°
                                if (requestData.type === 'STATUS_REQUEST' || requestData.type === 'TRADE_REQUEST') {
                                    addStatusRequestToDOM({
                                        requestId: msg.id,
                                        userName: msg.senderName,
                                        requestedStatus: requestData.requestedStatus || requestData.transactionType,
                                        currentStatus: requestData.currentStatus,
                                        regionName: requestData.regionName,
                                        addressDetail: requestData.addressDetail,
                                        amount: requestData.amount,
                                        status: requestData.status,
                                        isMine: msg.senderId == myUserId
                                    }, beforeId ? true : false);
                                    return;
                                }
                            } catch (e) {
                                // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì¼ë°˜ ë©”ì‹œì§€ë¡œ ì²˜ë¦¬
                            }
                        }
                        
                        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ (ìƒíƒœ ë³€ê²½ ì•Œë¦¼ ë“±)
                        if (msg.content && (
                            msg.content.includes('ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤') || 
                            msg.content.includes('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤') || 
                            msg.content.includes('ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤') ||
                            msg.content.includes('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤'))) {
                            addMessageToDOM({
                                id: msg.id,
                                type: 'system',
                                text: msg.content,
                                time: new Date(msg.createdAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                            }, beforeId ? true : false);
                            return;
                        }
                        
                        // ì¼ë°˜ ë©”ì‹œì§€
                        addMessageToDOM({
                            id: msg.id,
                            type: type,
                            text: msg.content,
                            image: msg.imageUrl,
                            time: new Date(msg.createdAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                            sender: msg.senderName
                        }, beforeId ? true : false);
                    });
                    
                    if (beforeId) {
                        // ë¬´í•œ ìŠ¤í¬ë¡¤: ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ìœ ì§€
                        const scrollHeightAfter = messagesContainer.scrollHeight;
                        messagesContainer.scrollTop = scrollHeightAfter - scrollHeightBefore;
                    } else {
                        // ì´ˆê¸° ë¡œë“œ: ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
                        scrollToBottom();
                    }
                }
                
                // ë” ì´ìƒ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ë¡œë”© íŠ¸ë¦¬ê±° ìˆ¨ê¹€
                loadMoreTrigger.style.display = hasMore ? 'none' : 'none';
            }
        } catch (error) {
            console.error('ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
        } finally {
            isLoadingMessages = false;
            loadMoreTrigger.style.display = 'none';
        }
    }

    // ì´ì „ ë©”ì‹œì§€ ë” ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadMoreMessages() {
        if (!currentRoomId || !oldestMessageId || !hasMoreMessages) return;
        await loadMessages(currentRoomId, oldestMessageId);
    }

    function sendMessage() {
        const text = messageInput.value.trim();

        if ((text || selectedImageBase64) && currentRoomId) {
            const messageData = {
                room: currentRoomId,
                user: myUserId,
                userName: myUserName,
                message: text,
                image: selectedImageBase64
            };

            // ì†Œì¼“ìœ¼ë¡œ ì „ì†¡ (ì„œë²„ì—ì„œ DBì— ì €ì¥í•¨)
            socket.emit('send_message', messageData);

            messageInput.value = '';
            clearImage();
            messageInput.focus();
        }
    }

    function clearImage() {
        fileInput.value = '';
        selectedImageBase64 = null;
        imagePreview.style.display = 'none';
    }

    function addMessageToDOM(msg, prepend = false) {
        console.log('addMessageToDOM í˜¸ì¶œ:', msg);
        
        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ì¸ ê²½ìš° float clear
        if (msg.type === 'system') {
            const clearDiv = document.createElement('div');
            clearDiv.style.cssText = 'clear: both; height: 0; overflow: hidden;';
            
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'system');
            messageDiv.style.cssText = 'display: block !important; text-align: center !important; margin: 15px auto !important; max-width: 80% !important; width: auto !important; float: none !important; clear: both !important; background: #f0f0f0 !important; border: none !important; box-shadow: none !important; padding: 10px 20px !important; border-radius: 20px !important; font-size: 13px; color: #666;';
            if (msg.id) {
                messageDiv.dataset.messageId = msg.id;
            }
            messageDiv.innerHTML = `<span>${msg.text}</span>`;
            
            if (prepend) {
                const firstMessage = messagesContainer.querySelector('.message');
                if (firstMessage) {
                    messagesContainer.insertBefore(clearDiv, firstMessage);
                    messagesContainer.insertBefore(messageDiv, firstMessage);
                } else {
                    messagesContainer.appendChild(clearDiv);
                    messagesContainer.appendChild(messageDiv);
                }
            } else {
                messagesContainer.appendChild(clearDiv);
                messagesContainer.appendChild(messageDiv);
            }
            return;
        }
        
        // ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', msg.type);
        if (msg.id) {
            messageDiv.dataset.messageId = msg.id;
        }
        
        let htmlContent = '';

        if (msg.sender && msg.type !== 'system') {
            const senderName = msg.type === 'sent' ? 'ë‚˜' : msg.sender;
            htmlContent += `<span class="message-sender">${senderName}</span>`;
        }

        if (msg.image) {
            htmlContent += `<img src="${msg.image}" alt="ì²¨ë¶€ ì´ë¯¸ì§€" />`;
        }

        if (msg.text) {
            htmlContent += `<span>${msg.text}</span>`;
        }

        if (msg.type !== 'system') {
            htmlContent += `<span class="message-time">${msg.time || ''}</span>`;
        }

        messageDiv.innerHTML = htmlContent;
        
        if (prepend) {
            // ë§¨ ì•ì— ì‚½ì… (loadMoreTrigger ë°”ë¡œ ë‹¤ìŒ)
            const firstMessage = messagesContainer.querySelector('.message');
            if (firstMessage) {
                messagesContainer.insertBefore(messageDiv, firstMessage);
            } else {
                messagesContainer.appendChild(messageDiv);
            }
        } else {
            messagesContainer.appendChild(messageDiv);
        }
    }

    // í†µí•©ëœ ìƒíƒœ ë³€ê²½ ìš”ì²­ DOM í•¨ìˆ˜
    function addStatusRequestToDOM(request, prepend = false) {
        console.log('addStatusRequestToDOM í˜¸ì¶œ:', request);
        
        // float clearë¥¼ ìœ„í•œ ë¹ˆ div ì¶”ê°€
        const clearDiv = document.createElement('div');
        clearDiv.style.cssText = 'clear: both; height: 0; overflow: hidden;';
        
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = 'display: block; text-align: center; margin: 20px auto; max-width: 100%; width: 100%; float: none; clear: both; background: transparent; border: none; box-shadow: none; padding: 0; border-radius: 0;';
        messageDiv.classList.add('status-request-message');
        messageDiv.dataset.requestId = request.requestId;
        
        const requestedStatus = request.requestedStatus;
        const isApproved = request.status === 'APPROVED';
        const isRejected = request.status === 'REJECTED';
        const isPending = request.status === 'PENDING' || !request.status;
        
        // ìš”ì²­ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ ë° í…ìŠ¤íŠ¸
        const typeInfo = {
            'IN_PERSON': { icon: 'ğŸš¶', text: 'ì§ê±°ë˜ ìš”ì²­', color: '#28a745' },
            'SHIPPING': { icon: 'ğŸšš', text: 'ë°°ì†¡ ìš”ì²­', color: '#007bff' },
            'COMPLETED': { icon: 'âœ…', text: 'ê±°ë˜ì™„ë£Œ ìš”ì²­', color: '#17a2b8' },
            'CANCELED': { icon: 'âŒ', text: 'ê±°ë˜ì·¨ì†Œ ìš”ì²­', color: '#dc3545' },
            'PENDING': { icon: 'ğŸ¤', text: 'í˜‘ì˜ì¤‘ ìš”ì²­', color: '#ffc107' }
        };
        
        const info = typeInfo[requestedStatus] || { icon: 'ğŸ”„', text: 'ìƒíƒœ ë³€ê²½ ìš”ì²­', color: '#6c757d' };
        
        // ìƒíƒœ ê²°ê³¼ HTML
        let statusHtml = '';
        if (isApproved) {
            statusHtml = '<div class="request-result approved"><strong>âœ… ìŠ¹ì¸ë¨</strong></div>';
        } else if (isRejected) {
            statusHtml = '<div class="request-result rejected"><strong>âŒ ê±°ë¶€ë¨</strong></div>';
        }
        
        // ë²„íŠ¼ HTML
        let buttonsHtml = '';
        if (isPending && !request.isMine) {
            buttonsHtml = `
                <div class="trade-request-buttons">
                    <button class="trade-request-btn accept" onclick="respondToStatusRequest(${request.requestId}, true)">âœ… ìˆ˜ë½</button><button class="trade-request-btn reject" onclick="respondToStatusRequest(${request.requestId}, false)">âŒ ê±°ë¶€</button>
                </div>
            `;
        } else if (isPending && request.isMine) {
            statusHtml = '<div class="request-pending"><span>â³ ìŠ¹ì¸ ëŒ€ê¸°ì¤‘</span></div>';
        }
        
        // ìƒì„¸ ì •ë³´ HTML (ì§ê±°ë˜/ë°°ì†¡ì¸ ê²½ìš°)
        let detailsHtml = '';
        if ((requestedStatus === 'IN_PERSON' || requestedStatus === 'SHIPPING') && request.amount !== undefined) {
            detailsHtml = `
                <div class="trade-request-details">
                    <div class="detail-item">
                        <span class="detail-icon">ğŸ“</span>
                        <span class="detail-label">ê±°ë˜ ì§€ì—­</span>
                        <span class="detail-value">${request.regionName || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">ğŸ </span>
                        <span class="detail-label">ìƒì„¸ ì£¼ì†Œ</span>
                        <span class="detail-value">${request.addressDetail || '-'}</span>
                    </div>
                    <div class="detail-item highlight">
                        <span class="detail-icon">ğŸ’°</span>
                        <span class="detail-label">í˜‘ì˜ ê¸ˆì•¡</span>
                        <span class="detail-value price">${Number(request.amount).toLocaleString()}ì›</span>
                    </div>
                </div>
            `;
        }
        
        const htmlContent = `
            <div class="trade-request-card">
                <div class="trade-request-header" style="background: linear-gradient(135deg, ${info.color} 0%, ${info.color}cc 100%);">
                    ${info.icon} <strong>${request.userName}</strong>ë‹˜ì˜ ${info.text}
                </div>
                ${detailsHtml}
                ${statusHtml}
                ${buttonsHtml}
            </div>
        `;
        
        messageDiv.innerHTML = htmlContent;
        
        if (prepend) {
            messagesContainer.insertBefore(clearDiv, messagesContainer.firstChild);
            messagesContainer.insertBefore(messageDiv, clearDiv.nextSibling);
        } else {
            messagesContainer.appendChild(clearDiv);
            messagesContainer.appendChild(messageDiv);
        }
    }

    // ìƒíƒœ ë³€ê²½ ìš”ì²­ í•¨ìˆ˜ (API í˜¸ì¶œ)
    async function sendStatusChangeRequest(requestedStatus, additionalInfo = null) {
        if (!currentRoomId) return;
        
        console.log('ìƒíƒœ ë³€ê²½ ìš”ì²­ ì „ì†¡:', { requestedStatus, additionalInfo });
        
        try {
            const body = { requestedStatus };
            if (additionalInfo) {
                body.regionCode = additionalInfo.regionCode;
                body.addressDetail = additionalInfo.addressDetail;
                body.amount = additionalInfo.amount;
            }
            
            const response = await fetch(`/api/chat/${currentRoomId}/status-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            const result = await response.json();
            console.log('ìƒíƒœ ë³€ê²½ ìš”ì²­ ì‘ë‹µ:', result);
            
            if (result.code === 200 || result.code === 201) {
                // ì†Œì¼“ìœ¼ë¡œ ìƒëŒ€ë°©ì—ê²Œ ì•Œë¦¼
                socket.emit('send_status_request', {
                    room: currentRoomId,
                    user: myUserId,
                    userName: myUserName,
                    messageId: result.result.message.id,
                    requestedStatus: requestedStatus,
                    currentStatus: currentStatus,
                    regionName: result.result.requestData?.regionName,
                    addressDetail: result.result.requestData?.addressDetail,
                    amount: result.result.requestData?.amount
                });
                
                // ë‚´ í™”ë©´ì—ë„ í‘œì‹œ
                addStatusRequestToDOM({
                    requestId: result.result.message.id,
                    userName: myUserName,
                    requestedStatus: requestedStatus,
                    currentStatus: currentStatus,
                    regionName: result.result.requestData?.regionName,
                    addressDetail: result.result.requestData?.addressDetail,
                    amount: result.result.requestData?.amount,
                    isMine: true
                });
                
                scrollToBottom();
            } else {
                alert(result.message || 'ìš”ì²­ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ìƒíƒœ ë³€ê²½ ìš”ì²­ ì˜¤ë¥˜:', error);
            alert('ìš”ì²­ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ìƒíƒœ ë³€ê²½ ìš”ì²­ ì‘ë‹µ í•¨ìˆ˜
    async function respondToStatusRequest(messageId, approved) {
        const endpoint = approved ? 'approve' : 'reject';
        
        console.log('ìƒíƒœ ë³€ê²½ ì‘ë‹µ ì‹œì‘:', { messageId, approved, endpoint, currentRoomId });
        
        try {
            const response = await fetch(`/api/chat/${currentRoomId}/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messageId: messageId })
            });
            
            console.log('ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
            
            const result = await response.json();
            console.log('ì‘ë‹µ ê²°ê³¼:', result);
            
            if (result.code === 200) {
                // ì†Œì¼“ìœ¼ë¡œ ìƒëŒ€ë°©ì—ê²Œ ì•Œë¦¼
                socket.emit('status_request_response', {
                    room: currentRoomId,
                    messageId: messageId,
                    approved: approved,
                    newStatus: result.result?.newStatus
                });
                
                // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ìƒíƒœ í‘œì‹œ
                const requestDiv = document.querySelector(`[data-request-id="${messageId}"]`);
                if (requestDiv) {
                    const buttonsArea = requestDiv.querySelector('.trade-request-buttons');
                    
                    if (approved) {
                        currentStatus = result.result?.newStatus || currentStatus;
                        updateStatusBadge(currentStatus);
                        updateRoomStatusBadge(currentRoomId, currentStatus);
                        if (buttonsArea) {
                            buttonsArea.outerHTML = '<div class="request-result approved"><strong>âœ… ìŠ¹ì¸ë¨</strong></div>';
                        }
                        addMessageToDOM({
                            type: 'system',
                            text: `ê±°ë˜ ìƒíƒœê°€ '${getStatusText(currentStatus)}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`
                        });
                    } else {
                        if (buttonsArea) {
                            buttonsArea.outerHTML = '<div class="request-result rejected"><strong>âŒ ê±°ë¶€ë¨</strong></div>';
                        }
                        addMessageToDOM({
                            type: 'system',
                            text: 'ìƒíƒœ ë³€ê²½ ìš”ì²­ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.'
                        });
                    }
                }
                scrollToBottom();
            } else {
                alert(result.message || 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('ìƒíƒœ ë³€ê²½ ì‘ë‹µ ì˜¤ë¥˜:', error);
            alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    window.respondToStatusRequest = respondToStatusRequest;

    function openTradeModal(transactionType) {
        // ëª¨ë‹¬ì´ ì´ë¯¸ ìˆìœ¼ë©´ ì œê±°
        const existingModal = document.getElementById('trade-modal');
        if (existingModal) existingModal.remove();
        
        const titleText = transactionType === 'IN_PERSON' ? 'ğŸš¶ ì§ê±°ë˜ ìš”ì²­' : 'ğŸšš ë°°ì†¡ ìš”ì²­';
        const locationLabel = transactionType === 'IN_PERSON' ? 'ì§ê±°ë˜ ì¥ì†Œ' : 'ë°°ì†¡ì§€';
        
        const modalHtml = `
            <div id="trade-modal" class="modal" style="display: flex;">
                <div class="modal-content">
                    <span class="modal-close" onclick="closeTradeModal()">&times;</span>
                    <h2>${titleText}</h2>
                    <form onsubmit="submitTradeRequest(event)">
                        <input type="hidden" id="modal-transaction-type" value="${transactionType}">
                        
                        <div class="modal-form-group">
                            <label for="modal-region-code">ğŸ“ ${locationLabel} ì§€ì—­ì½”ë“œ</label>
                            <input type="text" id="modal-region-code" placeholder="ì˜ˆ: 1100000000" required>
                        </div>
                        
                        <div class="modal-form-group">
                            <label for="modal-address-detail">ğŸ  ìƒì„¸ ì£¼ì†Œ</label>
                            <input type="text" id="modal-address-detail" placeholder="${transactionType === 'IN_PERSON' ? 'ì˜ˆ: ê°•ë‚¨ì—­ 5ë²ˆ ì¶œêµ¬' : 'ì˜ˆ: ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123-45'}" required>
                        </div>
                        
                        <div class="modal-form-group">
                            <label for="modal-amount">ğŸ’° ìµœì¢… í˜‘ì˜ ê¸ˆì•¡</label>
                            <input type="number" id="modal-amount" placeholder="ìµœì¢… ê±°ë˜ ê¸ˆì•¡" required>
                        </div>
                        
                        <button type="submit" class="modal-submit-btn">ìš”ì²­ ë³´ë‚´ê¸°</button>
                    </form>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.openTradeModal = openTradeModal;

    function closeTradeModal() {
        const modal = document.getElementById('trade-modal');
        if (modal) modal.remove();
    }
    window.closeTradeModal = closeTradeModal;

    async function submitTradeRequest(e) {
        e.preventDefault();
        
        const transactionType = document.getElementById('modal-transaction-type').value;
        const regionCode = document.getElementById('modal-region-code').value;
        const addressDetail = document.getElementById('modal-address-detail').value;
        const amount = Number(document.getElementById('modal-amount').value);
        
        closeTradeModal();
        
        // í†µí•©ëœ ìƒíƒœ ë³€ê²½ ìš”ì²­ í•¨ìˆ˜ í˜¸ì¶œ
        await sendStatusChangeRequest(transactionType, {
            regionCode,
            addressDetail,
            amount
        });
    }
    window.submitTradeRequest = submitTradeRequest;

    function updateLastMessage(roomId, text) {
        const roomItem = document.querySelector(`[data-room-id="${roomId}"]`);
        if (roomItem) {
            const lastMessageElement = roomItem.querySelector('.room-last-message');
            if (lastMessageElement) {
                lastMessageElement.textContent = text;
            }
        }
    }

    // ì‚¬ì´ë“œë°” ì±„íŒ…ë°©ì˜ ìƒíƒœ ë±ƒì§€ ì—…ë°ì´íŠ¸
    function updateRoomStatusBadge(roomId, status) {
        const roomItem = document.querySelector(`[data-room-id="${roomId}"]`);
        if (roomItem) {
            roomItem.dataset.status = status;
            const statusBadge = roomItem.querySelector('.room-status');
            if (statusBadge) {
                statusBadge.className = 'room-status ' + status.toLowerCase();
                statusBadge.textContent = getStatusBadge(status);
            }
        }
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„ íƒëœ ì±„íŒ…ë°©ì´ ìˆìœ¼ë©´ ìë™ ì„ íƒ
    document.addEventListener('DOMContentLoaded', () => {
        <% if (typeof selectedRoomId !== 'undefined' && selectedRoomId) { %>
        const selectedRoomId = <%= selectedRoomId %>;
        const roomElement = document.querySelector(`[data-room-id="${selectedRoomId}"]`);
        if (roomElement) {
            const roomId = roomElement.dataset.roomId;
            const postId = roomElement.dataset.postId;
            const postTitle = roomElement.dataset.postTitle;
            const otherUser = roomElement.dataset.otherUser;
            const status = roomElement.dataset.status;
            selectRoom(roomId, postId, postTitle, otherUser, status, roomElement);
        }
        <% } %>
    });
</script>

<%
function getStatusBadge(status) {
    const statusMap = {
        'PENDING': 'ğŸ¤ í˜‘ì˜ì¤‘',
        'IN_PERSON': 'ğŸš¶ ì§ê±°ë˜',
        'SHIPPING': 'ğŸšš ë°°ì†¡ì¤‘',
        'CANCELED': 'âŒ ì·¨ì†Œ',
        'COMPLETED': 'âœ… ì™„ë£Œ'
    };
    return statusMap[status] || 'ğŸ¤ í˜‘ì˜ì¤‘';
}

function formatTimeAgo(dateInput) {
    const date = new Date(dateInput);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
    if (diffMins < 60) return diffMins + 'ë¶„ ì „';
    if (diffHours < 24) return diffHours + 'ì‹œê°„ ì „';
    if (diffDays < 7) return diffDays + 'ì¼ ì „';
    return date.toLocaleDateString('ko-KR');
}
%>