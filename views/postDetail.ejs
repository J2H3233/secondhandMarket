<% 
    title = (post && post.title ? post.title + ' - ' : '') + '중고마켓';
    additionalCSS = ['/css/postDetail.css'];
%>

<!-- 상품 상세 내용 -->
<main class="post-detail-container">
  <div class="post-content">
    
    <!-- 이미지 섹션 -->
    <div class="image-section">
      <% if (post.post_img && post.post_img.length > 0) { %>
        <div class="main-image">
          <img src="/uploads/temp/<%= post.post_img[0].url %>" alt="<%= post.title %>" id="mainImage">
        </div>
        <% if (post.post_img.length > 1) { %>
          <div class="thumbnail-images">
            <% post.post_img.forEach((image, index) => { %>
              <img src="/uploads/temp/<%= image.url %>" alt="상품 이미지 <%= index + 1 %>" 
                   class="thumbnail <%= index === 0 ? 'active' : '' %>"
                   onclick="changeMainImage('/uploads/temp/<%= image.url %>', this)">
            <% }) %>
          </div>
        <% } %>
      <% } else { %>
        <div class="no-image">
          <i class="fas fa-image"></i>
          <p>이미지가 없습니다</p>
        </div>
      <% } %>
    </div>

    <!-- 상품 정보 섹션 -->
    <div class="info-section">
      
      <!-- 상품 기본 정보 -->
      <div class="product-info">
        <div class="product-header">
          <h1 class="product-title"><%= post.title %></h1>
          <div class="product-status">
            <span class="status-badge <%= post.status?.toLowerCase() || 'open' %>">
              <%= post.status === 'OPEN' ? '판매중' : post.status === 'CLOSE' ? '판매완료' : '상태미정' %>
            </span>
          </div>
        </div>
        
        <div class="price-info">
          <div class="main-price">
            <span class="price"><%= Number(post.price).toLocaleString() %>원</span>
            <% if (post.delivery_charge && Number(post.delivery_charge) > 0) { %>
              <span class="delivery-charge">배송비 <%= Number(post.delivery_charge).toLocaleString() %>원</span>
            <% } else { %>
              <span class="delivery-free">배송비 무료</span>
            <% } %>
          </div>
        </div>

        <div class="product-meta">
          <div class="meta-item">
            <i class="fas fa-tag"></i>
            <span>카테고리: <%= post.category?.category_name || '미분류' %></span>
          </div>
          <div class="meta-item">
            <i class="fas fa-truck"></i>
            <span>거래방식: <%= post.transaction_type === 'IN_PERSON' ? '직거래' : post.transaction_type === 'PARCEL' ? '택배거래' : '거래방식 미정' %></span>
          </div>
          <div class="meta-item">
            <i class="fas fa-map-marker-alt"></i>
            <span>지역: <% if (post.region) { %><%= (post.region.sido || '') + ' ' + (post.region.sigungu || '') + ' ' + (post.region.eubmyeonli || '') %><% } else { %>지역정보 없음<% } %></span>
          </div>
          <div class="meta-item">
            <i class="fas fa-clock"></i>
            <span>등록일: <%= new Date(post.created_at).toLocaleDateString('ko-KR') %></span>
          </div>
        </div>
      </div>

      <!-- 판매자 정보 -->
      <div class="seller-info">
        <h3>판매자 정보</h3>
        <div class="seller-profile">
          <div class="seller-avatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="seller-details">
            <div class="seller-name"><%= post.posting_user?.username || '알 수 없음' %></div>
          </div>
        </div>
      </div>

      <!-- 액션 버튼 -->
      <div class="action-buttons">
        <% if (user && post.posting_user && user.userId === post.posting_user.id) { %>
          <!-- 본인 게시물인 경우 -->
          <button class="btn btn-secondary" onclick="editPost('<%= post.id %>')">
            <i class="fas fa-edit"></i>
            수정하기
          </button>
          <button class="btn btn-danger" onclick="deletePost('<%= post.id %>')">
            <i class="fas fa-trash"></i>
            삭제하기
          </button>
        <% } else if (user) { %>
          <!-- 다른 사용자 게시물인 경우 -->
          <button class="btn btn-primary" onclick="contactSeller()">
            <i class="fas fa-comments"></i>
            판매자와 채팅
          </button>
          <button class="btn btn-secondary" onclick="toggleWishlist('<%= post.id %>')">
            <i class="fas fa-heart"></i>
            관심상품
          </button>
        <% } else { %>
          <!-- 비로그인 사용자 -->
          <button class="btn btn-primary" onclick="location.href='/auth/login'">
            <i class="fas fa-sign-in-alt"></i>
            로그인 후 연락하기
          </button>
        <% } %>
      </div>
    </div>
  </div>

  <!-- 상품 설명 -->
  <div class="description-section">
    <h3>상품 설명</h3>
    <div class="description-content">
      <%- post.content ? post.content.replace(/\n/g, '<br>') : '상품 설명이 없습니다.' %>
    </div>
  </div>
</main>

<script>
// 메인 이미지 변경
function changeMainImage(imageUrl, thumbnail) {
  const mainImage = document.getElementById('mainImage');
  if (mainImage && imageUrl) {
    mainImage.src = imageUrl;
    
    // 썸네일 활성화 상태 변경
    document.querySelectorAll('.thumbnail').forEach(thumb => {
      thumb.classList.remove('active');
    });
    if (thumbnail) {
      thumbnail.classList.add('active');
    }
  }
}

// 게시물 수정
function editPost(postId) {
  if (postId && postId !== '') {
    location.href = `/post/edit/${postId}`;
  }
}

// 게시물 삭제
function deletePost(postId) {
  if (!postId || postId === '') return;
  
  if (confirm('정말로 이 게시물을 삭제하시겠습니까?')) {
    fetch(`/api/post/${postId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (response.ok) {
        alert('게시물이 삭제되었습니다.');
        location.href = '/';
      } else {
        throw new Error('삭제 실패');
      }
    })
    .catch(error => {
      console.error('Delete error:', error);
      alert('삭제 중 오류가 발생했습니다.');
    });
  }
}

// 판매자 연락
function contactSeller() {
  location.href = '/chat';
}

// 관심상품 추가/제거
function toggleWishlist(postId) {
  if (!postId || postId === '') return;
  alert('관심상품 기능은 준비 중입니다.');
}
</script>