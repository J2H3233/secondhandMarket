<% 
    title = (post && post.title ? post.title + ' - ' : '') + '중고마켓';
    additionalCSS = ['/css/postDetail.css'];
%>

<!-- 상품 상세 내용 -->
<main class="post-detail-container">
  <div class="post-content">
    
    <!-- 이미지 섹션 -->
    <div class="image-section">
      <% if (post.post_img && post.post_img.length > 0) { %>
        <div class="main-image">
          <img src="/uploads/temp/<%= post.post_img[0].url %>" alt="<%= post.title %>" id="mainImage">
        </div>
        <% if (post.post_img.length > 1) { %>
          <div class="thumbnail-images">
            <% post.post_img.forEach((image, index) => { %>
              <img src="/uploads/temp/<%= image.url %>" alt="상품 이미지 <%= index + 1 %>" 
                   class="thumbnail <%= index === 0 ? 'active' : '' %>"
                   onclick="changeMainImage('/uploads/temp/<%= image.url %>', this)">
            <% }) %>
          </div>
        <% } %>
      <% } else { %>
        <div class="no-image">
          <i class="fas fa-image"></i>
          <p>이미지가 없습니다</p>
        </div>
      <% } %>
    </div>

    <!-- 상품 정보 섹션 -->
    <div class="info-section">
      
      <!-- 상품 기본 정보 -->
      <div class="product-info">
        <div class="product-header">
          <h1 class="product-title"><%= post.title %></h1>
          <div class="product-status">
            <span class="status-badge <%= post.status?.toLowerCase() || 'open' %>">
              <%= post.status === 'OPEN' ? '판매중' : post.status === 'CLOSE' ? '판매완료' : '상태미정' %>
            </span>
          </div>
        </div>
        
        <div class="price-info">
          <div class="main-price">
            <span class="price"><%= Number(post.price).toLocaleString() %>원</span>
            <% if (post.delivery_charge && Number(post.delivery_charge) > 0) { %>
              <span class="delivery-charge">배송비 <%= Number(post.delivery_charge).toLocaleString() %>원</span>
            <% } else { %>
              <span class="delivery-free">배송비 무료</span>
            <% } %>
          </div>
        </div>

        <div class="product-meta">
          <div class="meta-item">
            <i class="fas fa-tag"></i>
            <span>카테고리: <%= post.category?.category_name || '미분류' %></span>
          </div>
          <div class="meta-item">
            <i class="fas fa-truck"></i>
            <span>거래방식: <%= post.transaction_type === 'IN_PERSON' ? '직거래' : post.transaction_type === 'PARCEL' ? '택배거래' : '거래방식 미정' %></span>
          </div>
          <div class="meta-item">
            <i class="fas fa-map-marker-alt"></i>
            <span>지역: <% if (post.region) { %><%= (post.region.sido || '') + ' ' + (post.region.sigungu || '') + ' ' + (post.region.eubmyeonli || '') %><% } else { %>지역정보 없음<% } %></span>
          </div>
          <div class="meta-item">
            <i class="fas fa-clock"></i>
            <span>등록일: <%= new Date(post.created_at).toLocaleDateString('ko-KR') %></span>
          </div>
        </div>
      </div>

      <!-- 판매자 정보 -->
      <div class="seller-info">
        <h3>판매자 정보</h3>
        <div class="seller-profile">
          <div class="seller-avatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="seller-details">
            <div class="seller-name"><%= post.posting_user?.username || '알 수 없음' %></div>
            <% if (post.posting_user?.id) { %>
              <a href="/user/<%= post.posting_user.id %>" class="seller-profile-link">
                <i class="fas fa-store"></i>
                상점 보기
              </a>
            <% } %>
          </div>
        </div>
      </div>

      <!-- 액션 버튼 -->
      <div class="action-buttons">
        <% if (user && post.posting_user && user.userId === post.posting_user.id) { %>
          <!-- 본인 게시물인 경우 -->
          <button class="btn btn-secondary" onclick="editPost('<%= post.id %>')">
            <i class="fas fa-edit"></i>
            수정하기
          </button>
          <button class="btn btn-danger" onclick="deletePost('<%= post.id %>')">
            <i class="fas fa-trash"></i>
            삭제하기
          </button>
        <% } else if (user) { %>
          <!-- 다른 사용자 게시물인 경우 -->
          <button class="btn btn-primary" onclick="contactSeller()">
            <i class="fas fa-comments"></i>
            판매자와 채팅
          </button>
          <button class="btn btn-secondary" id="favoriteBtn" onclick="toggleFavorite('<%= post.id %>')">
            <i class="far fa-heart" id="favoriteIcon"></i>
            <span id="favoriteText">찜하기</span>
          </button>
        <% } else { %>
          <!-- 비로그인 사용자 -->
          <button class="btn btn-primary" onclick="location.href='/auth/login'">
            <i class="fas fa-sign-in-alt"></i>
            로그인 후 연락하기
          </button>
        <% } %>
      </div>
    </div>
  </div>

  <!-- 상품 설명 -->
  <div class="description-section">
    <h3>상품 설명</h3>
    <div class="description-content">
      <%- post.content ? post.content.replace(/\n/g, '<br>') : '상품 설명이 없습니다.' %>
    </div>
  </div>
</main>

<script>
// 메인 이미지 변경
function changeMainImage(imageUrl, thumbnail) {
  const mainImage = document.getElementById('mainImage');
  if (mainImage && imageUrl) {
    mainImage.src = imageUrl;
    
    // 썸네일 활성화 상태 변경
    document.querySelectorAll('.thumbnail').forEach(thumb => {
      thumb.classList.remove('active');
    });
    if (thumbnail) {
      thumbnail.classList.add('active');
    }
  }
}

// 게시물 수정
function editPost(postId) {
  if (postId && postId !== '') {
    location.href = `/post/${postId}/edit`;
  }
}

// 게시물 삭제
function deletePost(postId) {
  if (!postId || postId === '') return;
  
  if (confirm('정말로 이 게시물을 삭제하시겠습니까?')) {
    fetch(`/api/post/${postId}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (response.ok) {
        alert('게시물이 삭제되었습니다.');
        location.href = '/';
      } else {
        throw new Error('삭제 실패');
      }
    })
    .catch(error => {
      console.error('Delete error:', error);
      alert('삭제 중 오류가 발생했습니다.');
    });
  }
}

// 판매자 연락 (채팅방 생성)
async function contactSeller() {
  const postId = <%= post.id %>;
  
  try {
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ postId: postId })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // 채팅방이 생성되었거나 기존 채팅방을 찾았으면 해당 채팅방으로 바로 이동
      const tradeId = data.data.id;
      location.href = '/chat/' + tradeId;
    } else {
      alert(data.message || '채팅방 생성에 실패했습니다.');
    }
  } catch (error) {
    console.error('Chat room creation error:', error);
    alert('채팅방 생성 중 오류가 발생했습니다.');
  }
}

// 찜하기/찜 취소
let isFavorited = false;

async function toggleFavorite(postId) {
  if (!postId || postId === '') return;
  
  const btn = document.getElementById('favoriteBtn');
  const icon = document.getElementById('favoriteIcon');
  const text = document.getElementById('favoriteText');
  
  if (!btn || !icon || !text) {
    console.error('Required elements not found');
    return;
  }
  
  try {
    const response = await fetch(`/api/favorite/toggle/${postId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    
    if (data.success && data.data) {
      isFavorited = data.data.isFavorited;
      
      // 즉시 UI 업데이트
      if (isFavorited) {
        btn.className = 'btn btn-danger';
        icon.className = 'fas fa-heart';
        text.textContent = '찜 취소';
      } else {
        btn.className = 'btn btn-secondary';
        icon.className = 'far fa-heart';
        text.textContent = '찜하기';
      }
      
      showToast(isFavorited ? '찜 목록에 추가되었습니다.' : '찜 목록에서 제거되었습니다.');
    } else {
      alert(result.message || '찜하기에 실패했습니다.');
    }
  } catch (error) {
    console.error('toggleFavorite error:', error);
    alert('찜하기 처리 중 오류가 발생했습니다.');
  }
}

// 찜 상태 확인
async function checkFavoriteStatus(postId) {
  try {
    const response = await fetch(`/api/favorite/status/${postId}`);
    const data = await response.json();
    
    if (data.success && data.data) {
      isFavorited = data.data.isFavorited;
      
      const btn = document.getElementById('favoriteBtn');
      const icon = document.getElementById('favoriteIcon');
      const text = document.getElementById('favoriteText');
      
      if (btn && icon && text) {
        if (isFavorited) {
          btn.className = 'btn btn-danger';
          icon.className = 'fas fa-heart';
          text.textContent = '찜 취소';
        } else {
          btn.className = 'btn btn-secondary';
          icon.className = 'far fa-heart';
          text.textContent = '찜하기';
        }
      }
    }
  } catch (error) {
    console.error('checkFavoriteStatus error:', error);
  }
}

// 토스트 메시지 표시
function showToast(message) {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    z-index: 9999;
    animation: fadeInOut 2s ease-in-out;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2000);
}

// 페이지 로드 시 찜 상태 확인
document.addEventListener('DOMContentLoaded', function() {
  <% if (user && post.posting_user && user.userId !== post.posting_user.id) { %>
  const postId = <%= post.id %>;
  console.log('DOM Loaded, checking favorite status...');
  checkFavoriteStatus(postId);
  <% } %>
});

// 애니메이션 CSS 추가
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeInOut {
    0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
    10% { opacity: 1; transform: translateX(-50%) translateY(0); }
    90% { opacity: 1; transform: translateX(-50%) translateY(0); }
    100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
  }
`;
document.head.appendChild(style);
</script>