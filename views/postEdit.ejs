<% 
    title = '게시글 수정 - 중고마켓';
    additionalCSS = ['/css/posting.css'];
%>

<main class="posting-container">
  <div class="posting-header">
    <h1>게시글 수정</h1>
    <p>상품 정보를 수정해주세요</p>
  </div>

  <form id="editPostForm" class="posting-form">
    <input type="hidden" id="postId" value="<%= post.id %>">
    
    <div class="form-section">
      <h2>기본 정보</h2>
      
      <div class="form-group">
        <label for="title">제목 <span class="required">*</span></label>
        <input type="text" id="title" name="title" value="<%= post.title %>" required placeholder="제목을 입력하세요">
      </div>

      <div class="form-group">
        <label for="category">카테고리 <span class="required">*</span></label>
        <select id="category" name="category" required>
          <option value="">카테고리 선택</option>
          <option value="전자기기" <%= post.category?.category_name === '전자기기' ? 'selected' : '' %>>전자기기</option>
          <option value="의류/패션" <%= post.category?.category_name === '의류/패션' ? 'selected' : '' %>>의류/패션</option>
          <option value="도서/문구" <%= post.category?.category_name === '도서/문구' ? 'selected' : '' %>>도서/문구</option>
          <option value="생활용품" <%= post.category?.category_name === '생활용품' ? 'selected' : '' %>>생활용품</option>
          <option value="미용" <%= post.category?.category_name === '미용' ? 'selected' : '' %>>미용</option>
          <option value="식품" <%= post.category?.category_name === '식품' ? 'selected' : '' %>>식품</option>
          <option value="스포츠" <%= post.category?.category_name === '스포츠' ? 'selected' : '' %>>스포츠</option>
        </select>
      </div>

      <div class="form-group">
        <label for="price">가격 <span class="required">*</span></label>
        <input type="number" id="price" name="price" value="<%= post.price %>" required placeholder="가격을 입력하세요" min="0">
      </div>

      <div class="form-group">
        <label for="transaction_type">거래 방식 <span class="required">*</span></label>
        <select id="transaction_type" name="transaction_type" required onchange="updateTransactionTypeEdit()">
          <option value="">거래 방식 선택</option>
          <option value="IN_PERSON" <%= post.transaction_type === 'IN_PERSON' ? 'selected' : '' %>>직거래만</option>
          <option value="PARCEL" <%= post.transaction_type === 'PARCEL' ? 'selected' : '' %>>택배만</option>
          <option value="BOTH" <%= post.transaction_type === 'BOTH' ? 'selected' : '' %>>둘다 가능</option>
        </select>
      </div>

      <div class="form-group">
        <label for="delivery_charge">배송비</label>
        <input type="number" id="delivery_charge" name="delivery_charge" value="<%= post.delivery_charge || 0 %>" placeholder="배송비를 입력하세요 (0원은 무료배송)" min="0">
        <div class="form-help" id="deliveryHelpEdit" style="color: #94a3b8; margin-top: 8px; display: none;">직거래만 선택 시 배송비는 0원입니다</div>
      </div>
      
      <div class="form-group">
        <label for="status">판매 상태 <span class="required">*</span></label>
        <select id="status" name="status" required>
          <option value="OPEN" <%= post.status === 'OPEN' ? 'selected' : '' %>>판매중</option>
          <option value="CLOSE" <%= post.status === 'CLOSE' ? 'selected' : '' %>>판매완료</option>
        </select>
      </div>
    </div>

    <div class="form-section">
      <h2>상세 설명</h2>
      
      <div class="form-group">
        <label for="content">내용 <span class="required">*</span></label>
        <textarea id="content" name="content" required placeholder="상품에 대한 설명을 작성해주세요" rows="10"><%= post.content %></textarea>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">수정 완료</button>
      <button type="button" class="btn btn-secondary" onclick="history.back()">취소</button>
    </div>
  </form>
</main>

<script>
  document.getElementById('editPostForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const postId = document.getElementById('postId').value;
    const formData = {
      title: document.getElementById('title').value,
      category: document.getElementById('category').value,
      price: parseInt(document.getElementById('price').value),
      delivery_charge: parseInt(document.getElementById('delivery_charge').value) || 0,
      transaction_type: document.getElementById('transaction_type').value,
      content: document.getElementById('content').value,
      status: document.getElementById('status').value
    };
    
    try {
      const response = await fetch(`/api/post/${postId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert('게시글이 수정되었습니다.');
        window.location.href = `/post/${postId}`;
      } else {
        alert(data.message || '게시글 수정에 실패했습니다.');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('게시글 수정 중 오류가 발생했습니다.');
    }
  });

  // 거래 방식에 따른 배송비 입력 제어
  function updateTransactionTypeEdit() {
    const transactionType = document.getElementById('transaction_type').value;
    const deliveryChargeInput = document.getElementById('delivery_charge');
    const deliveryHelp = document.getElementById('deliveryHelpEdit');
    
    if (transactionType === 'IN_PERSON') {
      deliveryChargeInput.value = '0';
      deliveryChargeInput.disabled = true;
      deliveryHelp.style.display = 'block';
    } else {
      deliveryChargeInput.disabled = false;
      deliveryHelp.style.display = 'none';
    }
  }

  // 페이지 로드 시 초기화
  updateTransactionTypeEdit();

</script>
